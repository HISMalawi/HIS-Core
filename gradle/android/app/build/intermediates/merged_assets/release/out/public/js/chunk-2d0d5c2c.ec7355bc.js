(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0d5c2c"],{7052:function(e,t,a){"use strict";a.r(t);var i=a("7a23");function o(e,t,a,o,r,n){const s=Object(i["resolveComponent"])("his-standard-form");return Object(i["openBlock"])(),Object(i["createBlock"])(s,{fields:e.fields,activeField:e.activeField,onFinishAction:e.onFinish,skipSummary:!0,cancelDestinationPath:e.cancelDestination},null,8,["fields","activeField","onFinishAction","cancelDestinationPath"])}var r=a("d95e"),n=a("7920"),s=a("3800"),l=a("2706");class c{constructor(){this.BASE30_DIGITS_INDEX={},this.BASE30_DIGITS="0123456789ABCDEFGHJKLMNPRTVWXY".split(""),this.BASE30_DIGITS.forEach((e,t)=>this.BASE30_DIGITS_INDEX[e]=t)}convertFromDecimal(e,t=30){if(t<2||t>30)throw"Invalid base ${toBase}";let a="";while(e>0)a=this.BASE30_DIGITS[e%t]+a,e=Math.floor(e/t);return a}static calculateLuhnCheckDigit(e){const t=e.toString().split("").map(e=>Number.parseInt(e,10)),a=t.length%2;let i=0;t.forEach((e,t)=>{t%2===a&&(e*=2),e>9&&(e-=9),i+=e});const o=i%10;return 0===o?0:10-o}isValidDHACode(e){try{const t=this.convertToDecimal(e).toString(),a=(Number.parseInt(t[0],10),c.calculateLuhnCheckDigit(10*Number.parseInt(t,10)));return 0===a}catch(t){return console.error(t),!1}}convertToDecimal(e){if(0==e.length)return 0;const t=this.BASE30_DIGITS_INDEX[e[0]];if(void 0===t||null===t)throw"Invalid base ${fromBase} number: ${number}";return t*30**(e.length-1)+this.convertToDecimal(e.slice(1))}}var d=a("9283"),u=a("3d6c"),h=a("b5e4"),p=a("e86e"),b=a("1c74"),m=a("2ef0"),v=Object(i["defineComponent"])({components:{HisStandardForm:n["a"]},data:()=>({activeField:"",fields:[],drugs:[],selectedDrugs:[],barcode:"",stockService:{}}),methods:{async onFinish(e){const t=e.enter_batches;let a=[];for(let o=0;o<t.length;o++){const r=t[o].value,n=u["a"].getPackSize(r.drug_id),s=n*r.tins,l={},c={reallocation_code:e.authorization.value,quantity:s,reason:e.reasons.value};try{if("Relocations"===e.task.value){l["location_id"]=e.relocation_location.value;const t=await this.stockService.relocateItems(r.pharmacy_batch_id,{...c,...l});t||a.push("Could not save record for"+u["a"].getShortName(r.drug_id))}else{const e=await this.stockService.disposeItems(r.pharmacy_batch_id,{...c,...l});e||a.push("Could not save record for"+u["a"].getShortName(r.drug_id))}}catch(i){i instanceof b["a"]&&!Object(m["isEmpty"])(i.errors)?a=a.concat(i.errors):a.push(i),console.log(i)}}0===a.length?(Object(h["d"])("Stock succesfully moved"),this.$router.push("/")):Object(h["c"])(""+a.join(","))},getFields(){return[{id:"task",helpText:"Select task",type:r["b"].TT_SELECT,validation:e=>l["a"].required(e),options:()=>[{label:"Relocations",value:"Relocations"},{label:"Disposal",value:"Disposal"}]},{id:"relocation_location",helpText:"Destination",type:r["b"].TT_SELECT,validation:e=>l["a"].required(e)||l["a"].notTheSame(e.label,""+u["a"].getLocationName()),condition:e=>"Relocations"===e.task.value,options:(e,t="")=>Object(p["b"])(t),computedValue:e=>e.label,config:{showKeyboard:!0,isFilterDataViaApi:!0}},{id:"date",dynamicHelpText:e=>"Date of "+e.task.label,helpText:"Set date",type:r["b"].TT_FULL_DATE,validation:e=>l["a"].required(e)},{id:"select drugs",helpText:"Select drugs",type:r["b"].TT_MULTIPLE_SELECT,requireNext:!0,validation:e=>l["a"].required(e),options:async(e,t)=>{const a=await this.getItems();return a.map(e=>(e.isChecked=t.filter(t=>t.label===e.label).length>=1,e))},unload:e=>this.selectedDrugs=e},{id:"enter_batches",helpText:"Batch entry",type:r["b"].TT_BATCH_MOVEMENT,beforeNext:(e,t,a,{currentFieldContext:i})=>{const o=e=>e.map((e,t)=>""+e.label).join(" & "),r=i.drugs.filter(e=>e.entries.map(e=>!e.tins).every(Boolean));if(!Object(m["isEmpty"])(r)){const e=o(r);return Object(h["e"])("Please fix partial batch entries for drugs: "+e),!1}return!0},options:()=>this.selectedDrugs,validation:e=>l["a"].required(e)},{id:"authorization",helpText:"Enter authorization code",type:r["b"].TT_TEXT,config:{customKeyboard:[s["c"],[["Delete"]]]},validation:e=>{if(!e||e&&!e.value)return null;const t=e.value,a=new c;return a.isValidDHACode(t.toUpperCase())?null:["Invalid authorization code"]}},{id:"reasons",helpText:"Select reason",type:r["b"].TT_SELECT,validation:e=>l["a"].required(e),options:e=>this.getReasons(e)},{id:"summary",helpText:"Summary",type:r["b"].TT_TABLE_VIEWER,options:e=>this.buildResults(e),config:{hiddenFooterBtns:["Clear"]}}]},buildResults(e){const t="Relocations"===e.task.value,a=["Drug","Total units","Expiry date","Authorization code"];t&&a.push("Relocation");const i=e.enter_batches.map(a=>{const i=a.value,o=[u["a"].getShortName(i.drug_id),i.tins,d["b"].toStandardHisDisplayFormat(i.expiry),e.authorization.value.toUpperCase()];return t&&o.push(e.relocation_location.label),o});return[{label:"Confirm entry",value:"Table",other:{columns:a,rows:i}}]},prepDrugs(e){const t=[],a=this.barcode;return e.enter_batches.value.forEach(i=>{t.push({batch_number:i.batchNumber,items:[{barcode:a,drug_id:i.drugID,expiry_date:i.expiry,quantity:parseInt(i.tabs)*parseInt(i.tins),delivery_date:e.date.value}]})}),t},selectAll(e){return e.map(e=>(e.isChecked=!0,e))},async getItems(){const e=await this.stockService.getItems();return this.formatDrugs(e)},mapVal(e){return e.map(e=>({label:e,value:e}))},getReasons(e){return"Relocations"===e.task.value?this.mapVal(["Transfer to another facility/relocation","For trainings"]):this.mapVal(["Expired","Damaged","Phased out","Banned","Missing"])},formatDrugs(e){return e.map(e=>({label:`${u["a"].getShortName(e.drug_id)} (${u["a"].getPackSize(e.drug_id)}) Expiry date: ${d["b"].toStandardHisDisplayFormat(e.expiry_date)} \n          Batch (${e.batch_number})\n          `,value:e}))}},created(){this.stockService=new u["a"],this.fields=this.getFields()}}),g=a("6b0d"),T=a.n(g);const _=T()(v,[["render",o]]);t["default"]=_}}]);
//# sourceMappingURL=chunk-2d0d5c2c.ec7355bc.js.map